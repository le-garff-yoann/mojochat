<!DOCTYPE html>
<html>
  <head>
    <title>Mojochat</title>

    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

    <link
      rel="stylesheet"
      type="text/css"
      href="//fonts.googleapis.com/css?family=Ubuntu+Mono"
    >
    <link
      rel="stylesheet"
      type="text/css"
      href="https://fonts.googleapis.com/css?family=Indie+Flower"
    >
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
      integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
      crossorigin="anonymous"
    >

    <style type="text/css">
      * {
        font-family: "Ubuntu Mono";
      }

      body {
        background: lightblue;
        overflow: hidden;
      }

      .hand-written {
        font-family: "Indie Flower", serif;
      }

      #blabla {
        display: block;
        height: 95vh;
        overflow-y: scroll;
      }

      .bubble {
        border: 2px solid #dedede;
        border-radius: 5px;
        padding: 10px;
        margin: 10px 0;
      }

      .bubble::after {
        content: "";
        clear: both;
        display: block;
      }

      .me {
        background-color: lightgreen;
      }

      .others {
        background-color: yellow;
      }

      .meta-right {
        font-family: "Ubuntu Mono";
        color: #aaa;
        float: right;
      }
    </style>
  </head>

  <body>
    <script
      src="https://code.jquery.com/jquery-3.2.1.min.js"
      integrity="sha384-xBuQ/xzmlsLoJpyjoggmTEz8OWUFM0/RC5BsqQBDX2v5cMvDHcMakNTNrHIW2I5f"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
      integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
      crossorigin="anonymous"
    ></script>

    <script>
      $(document).ready(function(){
        $('#kit > *').prop('disabled', true);

        let log = function (msg) {
          $('<div class="container-fluid bubble"></div>')
            .addClass(msg.me ? 'me' : 'others')
            .append($('<p class="hand-written">' + msg.body + '</p>'))
            .append(
              $('<span class="meta-right"></span>')
                .append($('<b></b>').text(msg.uuid))
                .append(' at ')
                .append($('<i></i>').text(msg.datetime))
            )
            .prependTo('#blabla')
            .hide()
            .fadeIn(500)
            .delay(60000)
            .fadeOut(500);
        };

        let ws = new WebSocket(
          'ws' + (window.location.protocol === 'https:' ? 's' : '') + '://' + window.location.host + window.location.pathname + 'chat'
        );

        ws.onopen = function (e) {
          $('#kit > *').prop('disabled', false);

          $('#msgbox').focus();
        };

        ws.onclose = function (e) {
          $('#kit > *').prop('disabled', true);
        };

        ws.onmessage = function (e) {
          let msg = JSON.parse(e.data);

          log(msg);
        };

        $('#msgbox').keydown(function (e) {
          if (e.keyCode == 13 && $('#msgbox').val()) {
              ws.send($('#msgbox').val());

              $('#msgbox').val('');
          }
        });
      });
    </script>

    <div class="container-fluid">
      <div class="row" id="kit">
        <div class="col">
          <input placeholder="Type here..." type="text" class="container-fluid bubble hand-written" id="msgbox" />
        </div>
      </div>
      <div class="row">
        <div class="col" id="blabla"></div>
      </div>
    </div>
  </body>
</html>
